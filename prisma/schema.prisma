generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String             @id(map: "users_pkey") @default(cuid())
  email         String             @unique(map: "users_email_key")
  name          String
  password      String?
  role          UserRole
  image         String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  emailVerified DateTime?
  googleId      String?            @unique(map: "users_googleId_key")
  nim           String?
  nip           String?
  phoneNumber   String?
  angkatan      Int?
  prodi         String?
  avatarUrl     String?
  jenisKelamin  String?
  semesterAwal  String?
  jadwal        ScheduleEvent[]
  krs           KrsItem[]
  logAktivitas  ActivityLog[]
  pengingat     Reminder[]
  mengajar      Subject[]          @relation("DosenSubjects")

  @@index([email], map: "users_email_idx")
  @@index([nim], map: "users_nim_idx")
  @@index([nip], map: "users_nip_idx")
  @@index([role], map: "users_role_idx")
  @@map("pengguna")
}

model Subject {
  id           String              @id @default(cuid())
  kode         String              @unique(map: "subjects_kode_key")
  nama         String
  sks          Int
  semester     Int
  prodi        String?
  status       SubjectStatus       @default(aktif)
  angkatan     Int
  kelas        String
  color        String              @default("#3B82F6")
  slotDay      Int?
  slotStartUTC Int?
  slotEndUTC   Int?
  slotRuang    String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  jadwal       ScheduleEvent[]
  krs          KrsItem[]
  penawaran    CourseOffering[]
  pengingat    Reminder[]
  pengampu     User[]              @relation("DosenSubjects")

  @@index([angkatan], map: "subjects_angkatan_idx")
  @@index([kode], map: "subjects_kode_idx")
  @@index([status], map: "subjects_status_idx")
  @@map("matakuliah")
}

model CourseOffering {
  id           String         @id @default(cuid())
  subjectId    String
  angkatan     Int
  kelas        String
  semester     Int
  term         String?
  capacity     Int?
  status       OfferingStatus @default(buka)
  slotDay      Int?
  slotStartUTC Int?
  slotEndUTC   Int?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  krs          KrsItem[]
  matakuliah   Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade, map: "course_offerings_subjectId_fkey")

  @@index([angkatan], map: "course_offerings_angkatan_idx")
  @@index([status], map: "course_offerings_status_idx")
  @@index([subjectId], map: "course_offerings_subjectId_idx")
  @@map("penawaran")
}

model KrsItem {
  id         String          @id @default(cuid())
  userId     String
  subjectId  String
  offeringId String?
  term       String
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  penawaran  CourseOffering? @relation(fields: [offeringId], references: [id], map: "krs_items_offeringId_fkey")
  matakuliah Subject         @relation(fields: [subjectId], references: [id], onDelete: Cascade, map: "krs_items_subjectId_fkey")
  pengguna   User            @relation(fields: [userId], references: [id], onDelete: Cascade, map: "krs_items_userId_fkey")

  @@unique([userId, subjectId, term], map: "krs_items_userId_subjectId_term_key")
  @@index([subjectId], map: "krs_items_subjectId_idx")
  @@index([term], map: "krs_items_term_idx")
  @@index([userId], map: "krs_items_userId_idx")
  @@map("krs")
}

model ScheduleEvent {
  id         String   @id @default(cuid())
  userId     String
  subjectId  String?
  dayOfWeek  Int
  startUTC   Int
  endUTC     Int
  location   String?
  joinUrl    String?
  notes      String?
  color      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  matakuliah Subject? @relation(fields: [subjectId], references: [id], map: "schedule_events_subjectId_fkey")
  pengguna   User     @relation(fields: [userId], references: [id], onDelete: Cascade, map: "schedule_events_userId_fkey")

  @@index([dayOfWeek], map: "schedule_events_dayOfWeek_idx")
  @@index([subjectId], map: "schedule_events_subjectId_idx")
  @@index([userId], map: "schedule_events_userId_idx")
  @@map("jadwal")
}

model Reminder {
  id               String   @id(map: "reminders_pkey") @default(cuid())
  userId           String
  title            String
  dueUTC           BigInt
  relatedSubjectId String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  matakuliah       Subject? @relation(fields: [relatedSubjectId], references: [id], map: "reminders_relatedSubjectId_fkey")
  pengguna         User     @relation(fields: [userId], references: [id], onDelete: Cascade, map: "reminders_userId_fkey")

  @@index([dueUTC], map: "reminders_dueUTC_idx")
  @@index([isActive], map: "reminders_isActive_idx")
  @@index([userId], map: "reminders_userId_idx")
  @@map("pengingat")
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  category    String
  action      String
  icon        String   @default("Star")
  color       String   @default("text-gray-500")
  metadata    Json?
  createdAt   DateTime @default(now())
  pengguna    User     @relation(fields: [userId], references: [id], onDelete: Cascade, map: "activity_logs_userId_fkey")

  @@index([category], map: "activity_logs_category_idx")
  @@index([createdAt], map: "activity_logs_createdAt_idx")
  @@index([userId], map: "activity_logs_userId_idx")
  @@map("log_aktivitas")
}

enum UserRole {
  mahasiswa
  dosen
  kaprodi
  super_admin
}

enum SubjectStatus {
  aktif
  arsip
}

enum OfferingStatus {
  buka
  tutup
}
